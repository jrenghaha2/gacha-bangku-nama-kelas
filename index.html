<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gacha Bangku: Party Setup</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- TEYVAT PALETTE --- */
            --bg-void: #181b2a;
            --ui-panel: #e3e5e8;
            --ui-dark: #3b4255;
            
            /* Elements Colors */
            --pyro-red: #ec4923;
            --pyro-bg: linear-gradient(135deg, #702517 0%, #361515 100%);
            --electro-purp: #a757cb;
            --electro-bg: linear-gradient(135deg, #442657 0%, #221733 100%);
            --anemo-teal: #74c2a8;
            --anemo-bg: linear-gradient(135deg, #235446 0%, #112924 100%);
            
            /* Rarity */
            --star-5: #ffcc32;
            --text-light: #f0f0f0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--bg-void);
            background-image: 
                radial-gradient(circle at 50% 10%, #394363 0%, transparent 40%),
                radial-gradient(white, rgba(255,255,255,.1) 1px, transparent 1px);
            background-size: 100% 100%, 50px 50px;
            min-height: 100vh; margin: 0; padding: 15px;
            color: var(--text-light);
            overflow-x: hidden;
        }

        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        ::-webkit-scrollbar-thumb { background: var(--ui-panel); border-radius: 4px; border: 2px solid var(--bg-void); }

        .container { width: 100%; max-width: 1200px; margin: 0 auto; }

        /* --- HEADER --- */
        .header-section { display: flex; align-items: flex-end; justify-content: flex-start; margin-bottom: 30px; gap: 20px; flex-wrap: wrap; padding-left: 10px; }

        .teacher-desk {
            width: 200px; height: 90px;
            background: linear-gradient(to bottom, #dcdfe6, #cfd3dc);
            color: var(--ui-dark);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; 
            border: 2px solid #fff; 
            border-radius: 4px 4px 15px 15px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1); 
            flex-shrink: 0; z-index: 5; order: 1; position: relative;
            font-family: 'Cinzel', serif; font-weight: 700; font-size: 20px; letter-spacing: 1px;
        }
        .teacher-desk::before { content: "‚ú¶ ADVENTURERS ‚ú¶"; font-size: 9px; opacity: 0.6; letter-spacing: 2px; margin-bottom: 2px; font-family: 'Quicksand', sans-serif;}

        .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; padding-bottom: 5px; order: 2; }

        /* --- BUTTONS --- */
        .btn-tevyat {
             background: #ece5d8; color: #3b425d; border: none; border-radius: 50px;
             padding: 10px 24px; font-size: 15px; font-weight: bold; cursor: pointer; font-family: inherit;
             position: relative; overflow: hidden; user-select: none;
             box-shadow: 0 4px 0 #b4a898, 0 5px 10px rgba(0,0,0,0.3);
             transition: all 0.1s; display: flex; align-items: center; gap: 8px;
        }
        .btn-tevyat:active { transform: translateY(4px); box-shadow: 0 0 0 #b4a898; }
        
        .btn-wish { background: linear-gradient(to right, #e8cc8d, #d8b66e); color: #594524; box-shadow: 0 4px 0 #a08348, 0 5px 15px rgba(255, 204, 50, 0.2); }
        .btn-wish:active { box-shadow: 0 0 0 #a08348; }

        .primo-icon {
            width: 16px; height: 16px; background: linear-gradient(135deg, #a797ff, #6f80ff);
            clip-path: polygon(50% 0%, 100% 35%, 82% 100%, 18% 100%, 0% 35%); display: inline-block;
        }

        /* --- DROPDOWN --- */
        .dropdown { position: relative; }
        .dropdown-content { 
            display: none; position: absolute; top: 125%; left: 0; 
            background: rgba(40, 44, 58, 0.95); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            min-width: 220px; z-index: 50; backdrop-filter: blur(10px);
        }
        .dropdown-content button { 
            width: 100%; text-align: left; border: none; border-radius: 6px;
            padding: 12px; background: transparent; font-weight: bold; cursor: pointer; 
            font-family: inherit; font-size: 14px; color: #ece5d8;
            transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .dropdown-content button:hover { background: rgba(255,255,255,0.1); padding-left: 18px; color: var(--star-5); }
        .dropdown-content button:last-child { border-bottom: none; }
        .show { display: block; }

        /* --- GRID --- */
        .classroom-grid { display: grid; grid-template-columns: repeat(6, 1fr) 80px; gap: 15px; padding: 10px; align-items: center; }

        /* --- CHARACTER CARDS (UPDATED WITH PHOTO) --- */
        .seat {
            aspect-ratio: 4/5; position: relative; display: flex; flex-direction: column;
            justify-content: flex-start; /* Ubah ke flex-start biar gambar di atas */
            align-items: center; padding: 0;
            border-radius: 8px; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4); 
            transition: all 0.3s ease;
            min-height: 120px; /* Tambah tinggi dikit */
            border: 2px solid rgba(255,255,255,0.1);
            background-color: #1e2336;
        }

        /* Background Element Colors */
        .seat-row-0 { background: var(--pyro-bg); border-bottom: 4px solid var(--pyro-red); }
        .seat-row-1 { background: var(--electro-bg); border-bottom: 4px solid var(--electro-purp); }
        .seat-row-2 { background: var(--anemo-bg); border-bottom: 4px solid var(--anemo-teal); }

        .seat:hover { transform: translateY(-5px) scale(1.02); z-index: 2; }
        .seat-row-0:hover { box-shadow: 0 0 20px rgba(236, 73, 35, 0.4); border-color: var(--pyro-red); }
        .seat-row-1:hover { box-shadow: 0 0 20px rgba(167, 87, 203, 0.4); border-color: var(--electro-purp); }
        .seat-row-2:hover { box-shadow: 0 0 20px rgba(116, 194, 168, 0.4); border-color: var(--anemo-teal); }

        /* FOTO KARAKTER */
        .char-img-container {
            width: 100%; height: 70%; /* Ambil 70% tinggi kartu */
            overflow: hidden; position: relative;
            background-image: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 10px 10px;
        }
        
        .char-img {
            width: 100%; height: 100%; object-fit: cover;
            transition: 0.3s;
        }
        .seat:hover .char-img { transform: scale(1.1); }

        /* NAMA & INFO */
        .char-info {
            width: 100%; height: 30%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.4); 
            padding: 5px; position: relative;
            backdrop-filter: blur(2px);
        }

        .seat.is-locked .char-img { filter: grayscale(1) brightness(0.5); }
        .seat.is-locked { border: 2px solid var(--star-5) !important; }
        .seat.is-locked::after {
            content: "LOCKED"; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg);
            color: var(--star-5); font-weight: bold; font-family: 'Cinzel', serif; border: 3px solid var(--star-5); padding: 5px 10px;
            font-size: 14px; letter-spacing: 2px; z-index: 10;
        }
        
        .lock-box {
            position: absolute; top: 5px; right: 5px; width: 28px; height: 28px;
            background: rgba(0,0,0,0.6); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 20; transition: 0.2s; border: 1px solid rgba(255,255,255,0.5);
        }
        .lock-box:hover { background: #fff; color: #000; }

        .seat-name { 
            font-weight: 700; text-align: center; width: 100%; line-height: 1.1; 
            text-transform: uppercase; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            margin-bottom: 2px; z-index: 2;
        }
        .text-normal { font-size: 13px; } .text-medium { font-size: 11px; } .text-small { font-size: 9px; } .text-tiny { font-size: 8px; }

        .stars { color: var(--star-5); font-size: 10px; letter-spacing: 1px; z-index: 2;}
        .seat-number { 
            position: absolute; bottom: 2px; right: 4px; 
            font-size: 8px; color: rgba(255, 255, 255, 0.3); font-family: 'Cinzel', serif;
        }

        /* ROW LABEL */
        .row-label { 
            font-family: 'Cinzel', serif; font-size: 16px; font-weight: bold; 
            text-align: center; writing-mode: vertical-rl; text-orientation: mixed;
            text-shadow: 0 0 10px currentColor; letter-spacing: 3px;
        }
        .label-r0 { color: var(--pyro-red); }
        .label-r1 { color: var(--electro-purp); }
        .label-r2 { color: var(--anemo-teal); }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }
        .modal-content { 
            background: var(--ui-panel); color: var(--text-main);
            margin: 5% auto; padding: 25px; width: 90%; max-width: 550px; 
            border-radius: 4px; height: 85vh; max-height: 85vh; display: flex; flex-direction: column; 
            box-shadow: 0 0 0 4px rgba(255,255,255,0.1), 0 20px 50px rgba(0,0,0,0.8);
            position: relative;
        }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid rgba(0,0,0,0.1); padding-bottom: 10px; }
        .modal-title { margin: 0; font-family: 'Cinzel', serif; color: var(--ui-dark); font-size: 24px; }
        
        .close-btn { width: 30px; height: 30px; background: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; color: #555; transition: 0.2s; }
        .close-btn:hover { background: #3b425d; color: #fff; }

        .manager-input { width: 100%; padding: 12px; border: none; background: #fff; border-radius: 20px; font-family: inherit; font-weight: bold; color: var(--ui-dark); margin-bottom: 10px; flex-shrink: 0; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); }
        .manager-input:focus { outline: none; box-shadow: 0 0 0 2px var(--star-5); }
        
        .name-list { flex: 1 1 auto; min-height: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 8px; margin: 10px 0; }
        .name-item { padding: 12px; margin-bottom: 6px; border-radius: 6px; background: #fff; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.1s; }
        .name-item:hover { transform: translateX(5px); border-left: 4px solid var(--star-5); }
        .name-item.eliminated span { opacity: 0.4; text-decoration: line-through; }
        
        .action-btn { width: 28px; height: 28px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 5px; font-size: 12px; transition: 0.2s; }
        .btn-edit { background: #d4e4ff; color: #2980b9; }
        .btn-del { background: #fadbd8; color: #c0392b; }
        .btn-status { background: #abebc6; color: #27ae60; width: auto; padding: 0 10px; border-radius: 12px; }

        #bulkEditArea { flex: 1 1 auto; min-height: 0; overflow-y: auto; padding: 10px; border-radius: 8px; border: none; font-family: monospace; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            .header-section { flex-direction: column; align-items: center; padding-left: 0; gap: 10px;}
            .controls { order: 1; width: 100%; justify-content: center; display: grid; grid-template-columns: 1fr 1fr; margin-bottom: 20px; }
            .teacher-desk { order: 2; width: 100%; max-width: 280px; transform: rotate(0deg); margin-right: 0; margin-bottom: 15px; border-radius: 10px;}
            .dropdown { grid-column: span 2; } .dropdown button { width: 100%; justify-content: center; }
            .dropdown-content { left: 50%; transform: translateX(-50%); width: 95%; top: 110%; }
            .classroom-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 5px; }
            
            .row-label { 
                grid-column: 1 / -1; margin-top: 25px; margin-bottom: 10px; 
                writing-mode: horizontal-tb; text-orientation: mixed;
                border-bottom: 1px solid rgba(255,255,255,0.2); 
                padding-bottom: 5px; font-size: 14px;
            }
            .seat { aspect-ratio: unset; min-height: 90px; flex-direction: row; justify-content: space-between; padding: 0; align-items: center; background: #23283c;}
            /* Layout Mobile Horizontal */
            .char-img-container { width: 60px; height: 100%; border-right: 1px solid rgba(255,255,255,0.1); }
            .char-info { width: calc(100% - 60px); height: 100%; align-items: flex-start; padding-left: 10px; background: transparent;}
            .seat-name { text-align: left; }
            
            .seat-number { top: auto; bottom: 5px; right: 10px; }
            .stars { display: none; } 
            .modal-content { margin: 10% auto; height: 80vh; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <div class="teacher-desk">
            GUILD<br>MASTER
        </div>
        <div class="controls">
            <button class="btn-tevyat btn-wish" onclick="shuffleAll()">
                <div class="primo-icon"></div> WISH x10
            </button>
            <button class="btn-tevyat" onclick="openManager()">
                ‚öî PARTY SETUP
            </button>
            <div class="dropdown">
                <button class="btn-tevyat" onclick="toggleDropdown()" id="btnRowRandom" style="width:100%">
                    ‚ú¶ ELEMENTAL WISH ‚ñº
                </button>
                <div id="rowDropdown" class="dropdown-content">
                    <button onclick="shuffleSpecificRows([0])"><span style="color:var(--pyro-red)">üî• Pyro Banner (Baris 1)</span></button>
                    <button onclick="shuffleSpecificRows([1])"><span style="color:var(--electro-purp)">‚ö° Electro Banner (Baris 2)</span></button>
                    <button onclick="shuffleSpecificRows([2])"><span style="color:var(--anemo-teal)">üçÉ Anemo Banner (Baris 3)</span></button>
                    <button onclick="shuffleSpecificRows([0, 1])">üî• + ‚ö° Mix</button>
                    <button onclick="shuffleSpecificRows([1, 2])">‚ö° + üçÉ Mix</button>
                    <button onclick="shuffleSpecificRows([0, 2])">üî• + üçÉ Mix</button>
                </div>
            </div>
        </div>
    </div>

    <div id="classroom" class="classroom-grid"></div>
</div>

<div id="managerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">CHARACTER ARCHIVE</h2>
            <div class="close-btn" onclick="goBack()">‚úï</div>
        </div>
        
        <div id="normalView" style="display:flex; flex-direction:column; flex:1; min-height:0;">
            <div style="text-align:right; font-size:12px; margin-bottom:10px; flex-shrink:0; color:#666;">
                Total Characters: <span id="studentCount">0</span>/18
            </div>
            
            <div style="display:flex; gap:10px; flex-shrink:0; align-items: stretch;">
                <input type="text" id="newNameInput" class="manager-input" placeholder="New Character Name..." style="margin:0; flex:1; width:auto;" onkeypress="handleEnter(event)">
                <button class="btn-tevyat btn-wish" style="padding:0 20px; border-radius:20px; flex-shrink:0;" onclick="addName()">+</button>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:10px; align-items: stretch; flex-shrink:0;">
                 <input type="text" id="searchInput" class="manager-input" placeholder="üîç Search..." style="margin:0; font-size:14px; padding:8px; flex:1; width:auto;" onkeyup="renderNameList()">
                 <button class="btn-tevyat" style="height:auto; width:auto; flex-shrink:0; padding: 0 15px;" onclick="openBulkEdit()">üìù BULK</button>
            </div>
            
            <div class="name-list" id="nameListContainer"></div>
            
            <div class="modal-footer" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                <button class="btn-tevyat" style="font-size:12px; color:#c0392b; justify-content:center;" onclick="eliminateAll()">üö´ Expedition</button>
                <button class="btn-tevyat" style="font-size:12px; color:#27ae60; justify-content:center;" onclick="restoreAll()">‚úÖ Active</button>
                <button class="btn-tevyat" style="grid-column:span 2; font-size:12px; justify-content:center;" onclick="resetToDefault()">‚Üª Reset Archive</button>
            </div>
        </div>

        <div id="bulkView" style="display:none; flex-direction:column; flex:1; min-height:0;">
            <p style="margin:10px 0 5px 0; font-size:12px; color:#666; flex-shrink:0;">Paste names (1 per line):</p>
            <textarea id="bulkEditArea"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px; flex-shrink:0;">
                <button class="btn-tevyat" style="flex:1; color:#c0392b; justify-content:center;" onclick="goBack()">Cancel</button>
                <button class="btn-tevyat" style="flex:1; color:#27ae60; justify-content:center;" onclick="saveBulkEdit()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    const defaultNames = [
        "RAHMA KAMILA", "TASYA INTAN R.", "AKHSIN AMIRULLOH", 
        "ZERLINA DIAH M.", "YEHEZKIEL RAMLAN", "MAYANG MELDA D.", 
        "JESSICA PUTRI N.", "GALIH TRI P.", "ALIM MURSID", 
        "FARIHA NUR AZIZAH", "CALVIN JEREMIA", "LUKMAN HARIS M.", 
        "DESPIA ALIYAWATI", "FAIQ ATA AMRU", "ESTHER ANGGUN S.", 
        "REGA RINDIANA", "DENDRA RAMADANI", "MOHAMMAD IBAD F."
    ];

    let masterNames = defaultNames.map(name => ({ name: name, active: true }));
    let seats = [];

    // --- NAVIGATION LOGIC ---
    function goBack() { history.back(); }
    function lockBodyScroll() { document.body.style.overflow = 'hidden'; }
    function unlockBodyScroll() { document.body.style.overflow = ''; }

    window.onpopstate = function(event) {
        const state = event.state;
        document.getElementById('managerModal').style.display = "none";
        document.getElementById('bulkView').style.display = "none";
        document.getElementById('normalView').style.display = "flex";
        document.getElementById("rowDropdown").classList.remove('show');
        unlockBodyScroll(); 

        if (state && state.view === 'modal') {
            document.getElementById('managerModal').style.display = "block";
            lockBodyScroll();
            renderNameList();
        }
        if (state && state.view === 'bulk') {
            document.getElementById('managerModal').style.display = "block";
            document.getElementById('normalView').style.display = 'none'; 
            document.getElementById('bulkView').style.display = 'flex';
            lockBodyScroll();
        }
        if (state && state.view === 'dropdown') {
            document.getElementById("rowDropdown").classList.add('show');
        }
    };

    function openManager() { 
        document.getElementById("rowDropdown").classList.remove('show');
        history.pushState({view: 'modal'}, null, "");
        document.getElementById('managerModal').style.display = "block"; 
        document.getElementById('normalView').style.display = 'flex'; 
        document.getElementById('bulkView').style.display = 'none';
        lockBodyScroll(); 
        renderNameList(); 
    }

    function openBulkEdit() {
        history.pushState({view: 'bulk'}, null, "");
        document.getElementById('normalView').style.display = 'none'; 
        document.getElementById('bulkView').style.display = 'flex'; 
        document.getElementById('bulkEditArea').value = masterNames.map(n => n.name).join('\n'); 
    }

    function saveBulkEdit() {
        let lines = document.getElementById('bulkEditArea').value.split('\n').map(s => s.trim().toUpperCase()).filter(s => s);
        if(lines.length > 18) { alert("Max 18 Characters!"); return; }
        masterNames = lines.map(n => ({name:n, active:true}));
        goBack();
        seats.forEach(s => { s.currentName = ""; s.locked = false; }); 
        distributeNames(); 
        renderSeats();
    }

    function toggleDropdown() { 
        const dp = document.getElementById("rowDropdown");
        if (dp.classList.contains("show")) { goBack(); } 
        else { history.pushState({view: 'dropdown'}, null, ""); dp.classList.add("show"); }
    }

    document.addEventListener('keydown', (e) => { 
        if(e.key === "Escape") { if (history.state) goBack(); }
    });

    window.onclick = function(e) {
        if (!e.target.matches('#btnRowRandom') && !e.target.closest('#rowDropdown')) {
            if (document.getElementById("rowDropdown").classList.contains('show')) goBack();
        }
        if (e.target == document.getElementById('managerModal')) goBack();
    }

    // --- GAME LOGIC ---
    function initSeats() {
        seats = [];
        for (let i = 0; i < 18; i++) seats.push({ id: i, currentName: "", locked: false });
        distributeNames();
        renderSeats();
    }

    function renderSeats() {
        const container = document.getElementById('classroom');
        container.innerHTML = '';
        for (let row = 0; row < 3; row++) {
            for (let col = 0; col < 6; col++) {
                const index = row * 6 + col;
                const seatData = seats[index];
                const seatDiv = document.createElement('div');
                seatDiv.className = `seat seat-row-${row} ${seatData.locked ? 'is-locked' : ''}`;
                
                const lockIcon = seatData.locked ? 'üîí' : 'üîì';
                let nameHTML = seatData.currentName;
                
                // GENERATE AVATAR URL
                // Kita gunakan DiceBear Adventurer dengan seed = nama siswa
                // Supaya gambar konsisten per nama
                let avatarUrl = `https://api.dicebear.com/9.x/adventurer/svg?seed=${encodeURIComponent(nameHTML)}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
                if(!nameHTML) avatarUrl = "https://api.dicebear.com/9.x/adventurer/svg?seed=unknown&backgroundColor=transparent";

                let sizeClass = "text-normal";
                if (nameHTML.length > 20) sizeClass = "text-tiny";
                else if (nameHTML.length > 15) sizeClass = "text-small";
                else if (nameHTML.length > 10) sizeClass = "text-medium";

                // Stars logic based on row
                let stars = "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ";
                if(row === 1) stars = "‚òÖ‚òÖ‚òÖ‚òÖ";
                if(row === 2) stars = "‚òÖ‚òÖ‚òÖ";

                seatDiv.innerHTML = `
                    <div class="lock-box" onclick="toggleLock(${index}, event)">${lockIcon}</div>
                    <div class="char-img-container">
                        <img src="${avatarUrl}" class="char-img" alt="Avatar">
                    </div>
                    <div class="char-info">
                        <div class="seat-name ${sizeClass}">${nameHTML}</div>
                        <div class="stars">${stars}</div>
                    </div>
                    <div class="seat-number">NO. ${col + 1}</div>
                `;
                container.appendChild(seatDiv);
            }
            const label = document.createElement('div');
            label.className = `row-label label-r${row}`;
            
            let rowName = "ANEMO";
            if(row == 0) rowName = "PYRO";
            if(row == 1) rowName = "ELECTRO";
            
            label.innerText = rowName;
            container.appendChild(label);
        }
    }

    function distributeNames() {
        let lockedNames = seats.filter(s => s.locked && s.currentName).map(s => s.currentName);
        let availableNames = masterNames.filter(n => n.active).map(n => n.name).filter(name => !lockedNames.includes(name));
        shuffleArray(availableNames);
        seats.forEach(seat => { if (!seat.locked) seat.currentName = availableNames.length > 0 ? availableNames.shift() : ""; });
    }

    function shuffleAll() { distributeNames(); renderSeats(); }
    
    function shuffleSpecificRows(rowIndices) {
        let targetSeats = [];
        rowIndices.forEach(r => { for(let i=0; i<6; i++) { let seat = seats[r*6 + i]; if(!seat.locked) targetSeats.push(seat); } });
        let names = targetSeats.map(s => s.currentName).filter(n => n !== "");
        shuffleArray(names);
        targetSeats.forEach((seat, i) => seat.currentName = names[i] || "");
        renderSeats();
        goBack();
    }

    function toggleLock(index, e) {
        e.stopPropagation(); if(seats[index].currentName === "") return;
        seats[index].locked = !seats[index].locked; renderSeats();
    }

    function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }

    function renderNameList() {
        const list = document.getElementById('nameListContainer');
        const query = document.getElementById('searchInput').value.toUpperCase();
        const countSpan = document.getElementById('studentCount');
        countSpan.innerText = masterNames.length;
        list.innerHTML = '';
        masterNames.forEach((item, idx) => {
            if (item.name.includes(query)) {
                const div = document.createElement('div');
                div.className = `name-item ${!item.active ? 'eliminated' : ''}`;
                div.innerHTML = `
                    <span>${item.name}</span>
                    <div style="display:flex; align-items:center;">
                        <button class="action-btn btn-status" onclick="toggleActive(${idx})">${item.active ? 'ON' : 'OFF'}</button>
                        <button class="action-btn btn-edit" onclick="editName(${idx})">‚úé</button>
                        <button class="action-btn btn-del" onclick="deleteName(${idx})">üóë</button>
                    </div>`;
                list.appendChild(div);
            }
        });
    }

    function addName() {
        const val = document.getElementById('newNameInput').value.trim().toUpperCase();
        if (val && masterNames.length < 18) { masterNames.push({ name: val, active: true }); document.getElementById('newNameInput').value = ''; renderNameList(); } 
        else if (masterNames.length >= 18) alert("Max Characters!");
    }
    function handleEnter(e) { if(e.key === 'Enter') addName(); }
    function deleteName(idx) { if(confirm("Delete Character?")) { masterNames.splice(idx, 1); renderNameList(); } }
    function editName(idx) {
        let old = masterNames[idx].name; let baru = prompt("New Name:", old);
        if(baru) { let upper = baru.toUpperCase(); masterNames[idx].name = upper; seats.forEach(s => { if(s.currentName === old) s.currentName = upper; }); renderNameList(); }
    }
    function toggleActive(idx) { masterNames[idx].active = !masterNames[idx].active; renderNameList(); }
    function eliminateAll() { if(confirm("Send all to expedition?")) { masterNames.forEach(n => n.active = false); renderNameList(); }}
    function restoreAll() { masterNames.forEach(n => n.active = true); renderNameList(); }
    function resetToDefault() { if(confirm("Reset Data?")) { masterNames = defaultNames.map(n => ({name:n, active:true})); renderNameList(); seats.forEach(s => { s.currentName = ""; s.locked = false; }); distributeNames(); renderSeats(); }}

    initSeats();
</script>
</body>
</html>
